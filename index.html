
<!DOCTYPE html>
<html lang="fi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Karttaruudukko (mobiili parannettu)</title>
<style>
  body {
    font-family: sans-serif;
    margin: 0;
    padding: 10px;
    text-align: center;
    background: #f8f8f8;
  }
  canvas {
    width: 100%;
    height: auto;
    border: 1px solid #ccc;
    touch-action: none;
  }
  .controls {
    margin-top: 10px;
  }
  label {
    display: block;
    margin: 5px 0;
  }
  button {
    margin-top: 10px;
    padding: 8px 16px;
    font-size: 16px;
  }
</style>
</head>
<body>
<h2>Karttaruudukko</h2>
<input type="file" id="fileInput" accept="image/*"><br>
<div class="controls">
  <label>
    Rivit:
    <input type="range" id="rows" min="1" max="26" value="20">
    <span id="rowVal">20</span>
  </label>
  <label>
    Sarakkeet:
    <input type="range" id="cols" min="1" max="20" value="20">
    <span id="colVal">20</span>
  </label>
</div>
<canvas id="canvas"></canvas>
<p id="hoverInfo"></p>
<button id="downloadBtn" disabled>Lataa valittu alue</button>
<script>
const fileInput = document.getElementById("fileInput");
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
const rows = document.getElementById("rows");
const cols = document.getElementById("cols");
const rowVal = document.getElementById("rowVal");
const colVal = document.getElementById("colVal");
const hoverInfo = document.getElementById("hoverInfo");
const downloadBtn = document.getElementById("downloadBtn");

let img = new Image();
let selection = null;
let drawing = false;
let scale = 1;
let lastTouchDist = 0;

rows.oninput = () => rowVal.textContent = rows.value;
cols.oninput = () => colVal.textContent = cols.value;

fileInput.onchange = () => {
  const file = fileInput.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    img.onload = () => {
      const ratio = img.width / img.height;
      canvas.width = window.innerWidth;
      canvas.height = canvas.width / ratio;
      scale = 1;
      ctx.setTransform(1, 0, 0, 1, 0, 0);
      ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
    };
    img.src = e.target.result;
  };
  reader.readAsDataURL(file);
};

canvas.addEventListener("touchstart", (e) => {
  if (e.touches.length === 1 && !selection) {
    const rect = canvas.getBoundingClientRect();
    const x = e.touches[0].clientX - rect.left;
    const y = e.touches[0].clientY - rect.top;
    selection = { x, y, width: 0, height: 0 };
    drawing = true;
  } else if (e.touches.length === 2) {
    lastTouchDist = getTouchDistance(e.touches);
  }
});

canvas.addEventListener("touchmove", (e) => {
  if (e.touches.length === 1 && drawing) {
    e.preventDefault();
    const rect = canvas.getBoundingClientRect();
    const x = e.touches[0].clientX - rect.left;
    const y = e.touches[0].clientY - rect.top;
    selection.width = x - selection.x;
    selection.height = y - selection.y;
    redraw();
  } else if (e.touches.length === 2) {
    e.preventDefault();
    const newDist = getTouchDistance(e.touches);
    if (lastTouchDist) {
      const delta = newDist - lastTouchDist;
      scale = Math.max(0.5, Math.min(3, scale + delta * 0.005));
      redraw();
    }
    lastTouchDist = newDist;
  }
});

canvas.addEventListener("touchend", (e) => {
  if (drawing && selection) {
    drawing = false;
    normalize(selection);
    drawGrid(selection);
    downloadBtn.disabled = false;
  }
  lastTouchDist = 0;
});

canvas.addEventListener("touchstart", (e) => {
  if (selection && e.touches.length === 1) {
    const rect = canvas.getBoundingClientRect();
    const x = e.touches[0].clientX - rect.left;
    const y = e.touches[0].clientY - rect.top;
    showHoveredCell(x, y);
  }
});

function getTouchDistance(touches) {
  const dx = touches[0].clientX - touches[1].clientX;
  const dy = touches[0].clientY - touches[1].clientY;
  return Math.sqrt(dx * dx + dy * dy);
}

function normalize(box) {
  if (box.width < 0) {
    box.x += box.width;
    box.width *= -1;
  }
  if (box.height < 0) {
    box.y += box.height;
    box.height *= -1;
  }
}

function redraw() {
  ctx.setTransform(scale, 0, 0, scale, 0, 0);
  ctx.clearRect(0, 0, canvas.width / scale, canvas.height / scale);
  ctx.drawImage(img, 0, 0, canvas.width / scale, canvas.height / scale);
  if (selection) {
    ctx.setLineDash([5, 5]);
    ctx.strokeStyle = "#333";
    ctx.lineWidth = 2 / scale;
    ctx.strokeRect(selection.x, selection.y, selection.width, selection.height);
  }
}

function drawGrid(box) {
  redraw();
  const r = parseInt(rows.value);
  const c = parseInt(cols.value);
  const cellW = box.width / c;
  const cellH = box.height / r;
  ctx.setLineDash([]);
  ctx.strokeStyle = "rgba(0,0,0,0.5)";
  for (let i = 0; i <= c; i++) {
    const x = box.x + i * cellW;
    ctx.beginPath();
    ctx.moveTo(x, box.y);
    ctx.lineTo(x, box.y + box.height);
    ctx.stroke();
  }
  for (let j = 0; j <= r; j++) {
    const y = box.y + j * cellH;
    ctx.beginPath();
    ctx.moveTo(box.x, y);
    ctx.lineTo(box.x + box.width, y);
    ctx.stroke();
  }

  ctx.fillStyle = "#0f0";
  ctx.font = `${Math.min(cellW, cellH) * 0.3}px sans-serif`;
  ctx.textAlign = "center";
  ctx.textBaseline = "middle";
  for (let i = 0; i < c; i++) {
    ctx.fillText(i + 1, box.x + (i + 0.5) * cellW, box.y + cellH * 0.3);
  }
  const letters = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
  for (let j = 0; j < r; j++) {
    ctx.fillText(letters[j], box.x + cellW * 0.3, box.y + (j + 0.5) * cellH);
  }
}

function showHoveredCell(x, y) {
  const c = selection;
  if (!c) return;
  if (x >= c.x && x <= c.x + c.width && y >= c.y && y <= c.y + c.height) {
    const col = Math.floor(((x - c.x) * cols.value) / c.width) + 1;
    const row = "ABCDEFGHIJKLMNOPQRSTUVWXYZ"[Math.floor(((y - c.y) * rows.value) / c.height)];
    hoverInfo.textContent = `Rivi: ${row}, Sarake: ${col}`;
  } else {
    hoverInfo.textContent = "";
  }
}

downloadBtn.onclick = () => {
  if (!selection) return;
  const tempCanvas = document.createElement("canvas");
  tempCanvas.width = selection.width;
  tempCanvas.height = selection.height;
  const tempCtx = tempCanvas.getContext("2d");
  tempCtx.drawImage(
    canvas,
    selection.x * scale,
    selection.y * scale,
    selection.width * scale,
    selection.height * scale,
    0,
    0,
    selection.width,
    selection.height
  );
  const link = document.createElement("a");
  link.download = "rajattu_alue.png";
  link.href = tempCanvas.toDataURL();
  link.click();
};
</script>
</body>
</html>
